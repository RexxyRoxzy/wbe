<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Paramètres - Roxzy</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <a href="fr.html">← Retour</a>
    <h1>Paramètres du compte</h1>
  </header>

  <main class="main-content">
    <form id="settingsForm">
      <label>
        Pseudo:<br />
        <input type="text" id="pseudoInput" required minlength="3" />
      </label>
      <br /><br />
      <label>
        Bio:<br />
        <textarea id="bioInput" rows="4" placeholder="Ta bio ici..."></textarea>
      </label>
      <br /><br />
      <label>
        Photo de profil:<br />
        <input type="file" id="avatarInput" accept="image/*" />
      </label>
      <br /><br />
      <button type="submit">Sauvegarder</button>
    </form>
    <br />
    <button id="logoutBtn">Se déconnecter</button>
    <p id="msg" style="color:red;"></p>
  </main>

  <footer class="footer">© 2025 Roxzy</footer>

  <script>
    function loadCurrentUser() {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const currentUserId = localStorage.getItem("currentUserId");
      if (!currentUserId) {
        window.location.href = "index.html";
        return null;
      }
      const user = users.find(u => u.id === currentUserId);
      if (!user) {
        window.location.href = "index.html";
        return null;
      }
      return {user, users};
    }

    function isPseudoUnique(pseudo, users, currentUserId) {
      return !users.some(u => u.pseudo.toLowerCase() === pseudo.toLowerCase() && u.id !== currentUserId);
    }

    window.onload = function () {
      const data = loadCurrentUser();
      if (!data) return;
      const {user, users} = data;

      const pseudoInput = document.getElementById("pseudoInput");
      const bioInput = document.getElementById("bioInput");
      const avatarInput = document.getElementById("avatarInput");
      const msg = document.getElementById("msg");

      pseudoInput.value = user.pseudo;
      bioInput.value = user.bio;

      avatarInput.addEventListener("change", () => {
        const file = avatarInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          user.picture = e.target.result;
        };
        reader.readAsDataURL(file);
      });

      document.getElementById("settingsForm").onsubmit = function (e) {
        e.preventDefault();
        const newPseudo = pseudoInput.value.trim();
        if (newPseudo.length < 3) {
          msg.textContent = "Pseudo trop court (min 3 caractères).";
          return;
        }
        if (!isPseudoUnique(newPseudo, users, user.id)) {
          msg.textContent = "Pseudo déjà pris, choisis-en un autre.";
          return;
        }
        user.pseudo = newPseudo;
        user.bio = bioInput.value.trim();

        // Save back
        localStorage.setItem("users", JSON.stringify(users));
        msg.style.color = "green";
        msg.textContent = "Modifications sauvegardées !";

        setTimeout(() => {
          msg.textContent = "";
        }, 3000);
      };

      document.getElementById("logoutBtn").onclick = function () {
        localStorage.removeItem("currentUserId");
        window.location.href = "index.html";
      };
    };
  </script>

  <style>
    form label {
      color: white;
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      max-width: 400px;
      padding: 8px;
      border-radius: 6px;
      border: none;
    }

    body {
      background: #121212;
      color: white;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
    }

    .header a {
      color: #00ffea;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</body>
</html>
